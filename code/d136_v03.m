%% Dados do Sistema de 136 barras
% System data of 136 bars

% Dados globais
% Global data
nref  = 136;        % n?de referência
vref  = 1.00;        % tensão na subestação (pu)
vbase = 13.8;       % Tensão base (kV)
% sbase = 100000;     % Potência base (kVA)
tol   = 10^-8;      % Tolerância do erro permitida
vmin  = 0.95       % Tensão mínima (pu)
vmax  = 1       % Tensão máxima (pu)
% vmin  = 0.93       % Tensão mínima (pu)
% vmax  = 1.05       % Tensão máxima (pu)

% Base de impedância
% Basis of impedance
% zbase = 1000*((vbase^2)/sbase);

% Dados de ramos
% Branch data
%             de   para    R(ohm)     X(ohm)
%            from     to          R(ohm)          X(ohm)
Branch = [    136      1   0.33205    0.76653
               1      2   0.00188    0.00433
               2      3   0.22324    0.51535
               3      4   0.09943    0.22953
               4      5   0.15571    0.35945
               5      6   0.16321    0.37677
               6      7   0.11444    0.26417
               6      8   0.05675    0.05666
               8      9   0.52124    0.27418
               8     10   0.10877    0.10860
              10     11   0.39803    0.20937
              10     12   0.91744    0.31469
              10     13   0.11823    0.11805
              13     14   0.50228    0.26421
              13     15   0.05675    0.05666
              15     16   0.29379    0.15454
             136     17   0.33205    0.76653
              17     18   0.00188    0.00433
              18     19   0.22324    0.51535
              19     20   0.10881    0.25118
              20     21   0.71078    0.37388
              20     22   0.18197    0.42008
              22     23   0.30326    0.15952
              22     24   0.02439    0.05630
              24     25   0.04502    0.10394
              25     26   0.01876    0.04331
              26     27   0.11823    0.11805
              27     28   0.02365    0.02361
              28     29   0.18954    0.09970
              29     30   0.39803    0.20937
              28     31   0.05675    0.05666
              31     32   0.09477    0.04985
              32     33   0.41699    0.21934
              33     34   0.11372    0.05982
              31     35   0.07566    0.07555
              35     36   0.36960    0.19442
              36     37   0.26536    0.13958
              35     38   0.05675    0.05666
             136     39   0.33205    0.76653
              39     40   0.11819    0.27283
              40     41   2.96288    1.01628
              40     42   0.00188    0.00433
              42     43   0.06941    0.16024
              43     44   0.81502    0.42872
              43     45   0.06378    0.14724
              45     46   0.13132    0.30315
              46     47   0.06191    0.14291
              47     48   0.11444    0.26417
              48     49   0.28374    0.28331
              49     50   0.28374    0.28331
              48     51   0.04502    0.10394
              51     52   0.02626    0.06063
              52     53   0.06003    0.13858
              53     54   0.03002    0.06929
              54     55   0.02064    0.04764
              52     56   0.10881    0.25118
              56     57   0.25588    0.13460
              57     58   0.41699    0.21934
              58     59   0.50228    0.26421
              59     60   0.33170    0.17448
              60     61   0.20849    0.10967
              47     62   0.13882    0.32047
             136     63   0.00750    0.01732
              63     64   0.27014    0.62362
              64     65   0.38270    0.88346
              65     66   0.33018    0.76220
              66     67   0.32830    0.75787
              67     68   0.17072    0.39409
              68     69   0.55914    0.29412
              68     70   0.05816    0.13425
              70     71   0.70130    0.36890
              71     72   1.02352    0.53839
              70     73   0.06754    0.15591
              73     74   1.32352    0.45397
             136     75   0.01126    0.02598
              75     76   0.72976    1.68464
              76     77   0.22512    0.51968
              77     78   0.20824    0.48071
              78     79   0.04690    0.10827
              79     80   0.61950    0.61857
              80     81   0.34049    0.33998
              81     82   0.56862    0.29911
              81     83   0.10877    0.10860
              83     84   0.56862    0.29911
             136     85   0.01126    0.02598
              85     86   0.41835    0.96575
              86     87   0.10499    0.13641
              86     88   0.43898    1.01338
              88     89   0.07520    0.02579
              89     90   0.07692    0.17756 % 90
              90     91   0.33205    0.76653
              91     92   0.08442    0.19488
              92     93   0.13320    0.30748
              93     94   0.29320    0.29276
              94     95   0.21753    0.21721
              95     96   0.26482    0.26443
              93     97   0.10318    0.23819
              97     98   0.13507    0.31181
             136     99   0.00938    0.02165
              99    100   0.16884    0.38976
             100    101   0.11819    0.27283
             101    102   2.28608    0.78414
             101    103   0.45587    1.05236
             103    104   0.69600    1.60669
             104    105   0.45774    1.05669
             105    106   0.20298    0.26373
             106    107   0.21348    0.27737
             107    108   0.54967    0.28914
             108    109   0.54019    0.28415
             107    110   0.04550    0.05911
             110    111   0.47385    0.24926
             111    112   0.86241    0.45364
             112    113   0.56862    0.29911
             108    114   0.77711    0.40878
             114    115   1.08038    0.56830
             109    116   1.09933    0.57827
             116    117   0.47385    0.24926
             104    118   0.32267    0.74488
             118    119   0.14633    0.33779
             119    120   0.12382    0.28583
             136    121   0.01126    0.02598
             121    122   0.64910    1.49842
             122    123   0.04502    0.10394
             123    124   0.52640    0.18056
             123    125   0.02064    0.04764
             125    126   0.53071    0.27917
             125    127   0.09755    0.22520
             127    128   0.11819    0.27283
             127    129   0.13882    0.32047
             129    130   0.04315    0.09961
             130    131   0.09192    0.21220
             131    132   0.16134    0.37244
             132    133   0.37832    0.37775
             133    134   0.39724    0.39664
             134    135   0.29320    0.29276
               7     73   0.13132    0.30315
               9     24   0.26536    0.13958
              15     83   0.14187    0.14166
              38    135   0.08512    0.08499
              25     51   0.04502    0.10394
              50     96   0.14187    0.14166
              55     98   0.14187    0.14166
              62    120   0.03940    0.09094
              66     79   0.12944    0.29882
              79    131   0.01688    0.03898
              84    135   0.33170    0.17448
              91    104   0.14187    0.14166
              90    129   0.07692    0.17756
              90    103   0.07692    0.17756
              92    104   0.07692    0.17756
              92    132   0.07692    0.17756
              96    120   0.26482    0.26443
             110     47   0.49696    0.64567
             126     76   0.17059    0.08973
             128     77   0.05253    0.12126
             135     98   0.29320    0.29276 ];

%%
% Demanda de potência ativa e reativa nas barras
% active and reactive power demand at each bus
%            barra       Pd(kW)       Qd(kW)   Qbc(kW)
%           bus    Pd(kW)      Qd(kW)   Qbc(kW)
Bus    = [      
               136       0.0		  0.0      0.000 % substation
                 1       0.0		  0.0      0.000
                 2       47.780	      19.009   0.000
                 3       42.551	      16.929   0.000
                 4       87.022	      34.622   0.000
                 5       311.310	  123.855  0.000
                 6       148.869	  59.228   0.000
                 7       238.672	  94.956   0.000
                 8       62.299	      24.786   0.000
                 9       124.598	  49.571   0.000
                10       140.175	  55.768   0.000
                11       116.813	  46.474   0.000
                12       249.203	  99.145   0.000
                13       291.447	  115.952  0.000
                14       303.720	  120.835  0.000
                15       215.396	  85.695   0.000
                16       198.586	  79.007   0.000
                17       0.0		  0.0      0.000
                18       0.0		  0.0      0.000
                19       0.0		  0.0      0.000
                20       30.127	      14.729   0.000
                21       230.972	  112.920  0.000
                22       60.256	      29.458   0.000
                23       230.972	  112.920  0.000
                24       120.507	  58.915   0.000
                25       0.0		  0.0      0.000
                26       56.981	      27.857   0.000
                27       364.665	  178.281  0.000
                28       0.0		  0.0      0.000
                29       124.647	  60.939   0.000
                30       56.981	      27.857   0.000
                31       0.0		  0.0      0.000
                32       85.473	      41.787   0.000
                33       0.0		  0.0      0.000
                34       396.735	  193.960  0.000
                35       0.0		  0.0      0.000
                36       181.152	  88.563   0.000
                37       242.172	  118.395  0.000
                38       75.316	      36.821   0.000
                39       0.0		  0.0      0.000
                40       1.254	      0.531    0.000
                41       6.274	      2.660    0.000
                42       0.0		  0.0      0.000
                43       117.880	  49.971   0.000
                44       62.668	      26.566   0.000
                45       172.285	  73.034   0.000
                46       458.556	  194.388  0.000
                47       262.962	  111.473  0.000
                48       235.761	  99.942   0.000
                49       0.0		  0.0      0.000
                50       109.215	  46.298   0.000
                51       0.0		  0.0      0.000
                52       72.809	      30.865   0.000
                53       258.473	  109.570  0.000
                54       69.169	      29.322   0.000
                55       21.843	      9.260    0.000
                56       0.0		  0.0      0.000
                57       20.527	      8.702    0.000
                58       150.548	  63.819   0.000
                59       220.687	  93.552   0.000
                60       92.384	      39.163   0.000
                61       0.0		  0.0      0.000
                62       226.693	  96.098   0.000
                63       0.0		  0.0      0.000
                64       294.016	  116.974  0.000
                65       83.015	      33.028   0.000
                66       83.015	      33.028   0.000
                67       103.770	  41.285   0.000
                68       176.408	  70.184   0.000
                69       83.015	      33.028   0.000
                70       217.917	  86.698   0.000
                71       23.294	      9.267    0.000
                72       5.075	      2.019    0.000
                73       72.638	      28.899   0.000
                74       405.990	  161.5235 0.000 %                 74       405.990	  161.5235 0.000
                75       0.0		  0.0      0.000
                76       100.182	  42.468   0.000
                77       142.523	  60.417   0.000
                78       96.042	      40.713   0.000
                79       300.454	  127.366  0.000
                80       141.238	  59.873   0.000
                81       279.847	  118.631  0.000
                82       87.312	      37.013   0.000
                83       243.849	  103.371  0.000
                84       247.750	  105.025  0.000
                85       0.0		  0.0      0.000
                86       89.878	      38.101   0.000
                87       1137.280	  482.108  0.000
                88       458.339	  194.296  0.000
                89       385.197	  163.290  0.000
                90       0.0		  0.0      0.000
                91       79.608	      33.747   0.000
                92       87.312	      37.013   0.000
                93       0.0		  0.0      0.000
                94       74.001	      31.370   0.000
                95       232.050	  98.369   0.000
                96       141.819	  60.119   0.000
                97       0.0		  0.0      0.000
                98       76.449	      32.408   0.000
                99       0.0		  0.0      0.000
               100       51.322	      21.756   0.000
               101       59.874	      25.381   0.000
               102       9.065	      3.843    0.000
               103       2.092	      0.887    0.000
               104       16.735	      7.094    0.000
               105       1506.522	  638.634  0.000
               106       313.023	  132.694  0.000
               107       79.831	      33.842   0.000
               108       51.322	      21.756   0.000
               109       0.0		  0.0      0.000
               110       202.435	  85.815   0.000
               111       60.823	      25.784   0.000
               112       45.618	      19.338   0.000
               113       0.0		  0.0      0.000
               114       157.070	  66.584   0.000
               115       0.0		  0.0      0.000
               116       250.148	  106.041  0.000
               117       0.0		  0.0      0.000
               118       69.809	      29.593   0.000
               119       32.072	      13.596   0.000
               120       61.084	      25.894   0.000
               121       0.0		  0.0      0.000
               122       94.622	      46.260   0.000
               123       49.858	      24.375   0.000
               124       123.164	  60.214   0.000
               125       78.350	      38.304   0.000
               126       145.475	  71.121   0.000
               127       21.369	      10.447   0.000
               128       74.789	      36.564   0.000
               129       227.926	  111.431  0.000
               130       35.614	      17.411   0.000
               131       249.295	  121.877  0.000
               132       316.722	  154.842  0.000
               133       333.817	  163.199  0.000
               134       249.295	  121.877  0.000
               135       0.0          0.0      0.000 
                ];

% % % sum_loss_AC3 =   0.271845971097535
% % % sum_loss_franco3 =   0.280193024114961   % correct, zjp 2012-12-21

% From the above Bus, total active (reactive) demand is 18313.809 (7932.5335) kw correct, zjp 2012-12-21

% if change the 161.5235 in the 74th row 86-87 to 161.235, then the reactive load is equal to 9386.245
% In Borges2014Autom(Franco), the total reactive demand is 9384.827kVAr   wrong

%%
Gen_renew = [];
%% for renewable treated as PQ nodes
% if gen_type
%     for i = 1:size(Gen_renew, 1)  % DG treated as negative load
%         idx = find(Bus(:,1)==Gen_renew(i,1));
%         Bus(idx,2) = Bus(idx,2) - Gen_renew(i, 2);
%         Bus(idx,3) = Bus(idx,3) - Gen_renew(i, 3);
%     end    
% end

%%
% type = 'Mantov';  % use Mantove
% type = 'Olivei';  % use Olivei
data_type = [];        % use the Bus and Branch explicitly given above

if strcmp(data_type, 'Mantov')
%% show that Bus and Branch is the same as Mantov.m except the bus# and Branch #
    d136_Mantov
    Bus_same_as_Mantov = isequal(Bus(:,[2 3]), Bus_Mantov(:, [2 3])) % same
    Branch_same_as_Mantov = isequal(Branch(:, [3 4]), Branch_Mantov(:, [3 4])) % same
    Bus = Bus_Mantov;
    Branch = Branch_Mantov;
    % % % sum_loss_AC3 =   0.271845971097535
    % % % sum_loss_franco3 =   0.280193024114961  % correct, zjp 2012-12-21
   
elseif strcmp(data_type, 'Olivei')
%% show that Bus and Branch is the same as Olivei.m
    d136_Olivei % 
    Bus = Bus_Olivei;
    Branch = Branch_Olivei;
    % % % sum_loss_AC3 =   0.271845971097535
    % % % sum_loss_franco3 =   0.280193024114961  % correct, zjp 2012-12-21
else
    % use the Bus and Branch explicitly given above
end

% -------------- delete the follows ----------------------
% % show that after shifting Bus down by one row, 
% % % Bus and Branch is totally the same as Olivei.m
% % should not do the following two lines!    zjp 2012-12-21
% % Bus(2:136, [2 3]) = Bus(1:135, [2 3]); % change to Olivei load condition!
% % Bus(1, [2 3 4]) = [0 0 0]; % change to Olivei load condition!
% % % sum of active load is 18313.809 kW
% % % sum of reactive load is 7932.5335 kW
% 
% Bus_same_as_Olivei = isequal(Bus(:,[1 2 3]), Bus_Olivei) % same
% Branch_same_as_Olivei = isequal(Branch, Branch_Olivei) % same

%%  seems too much switch-connected bus, extra, not verified how to delete them
% d136_Alimen
% Bus = Bus_Alimen;
% Branch = Branch_Alimen;

%%

% isequal( Bus(:,[2 3]), data1(:,[6 7]) );
% % Bus(:,[2 3]) = data1(:,[6 7]);  % after this change, the d136's Bus is the same as data in d136_Olivei

% % Branch2 = [data1(:,[2:5]); data2(:,[2:5])];
% % idx = find(Branch2(:,1)==0);
% % Branch2(idx,1) = 136;
% % idx = find(Branch2(:,2)==0);
% % Branch2(idx,2) = 136; % after these change, the d136's Branch is the same as data in d136_Olivei
% % % isequal(Branch, Branch2) 
% % Branch = Branch2;

% idx = find(Bus(1:135,2) == 0);
% Bus(idx, [2 3]) = 0.1;
% % Qd_min = 0.5
% % idx = find(Bus(1:135,2) < Qd_min);
% % Bus(idx, [3]) = Qd_min;
% % fprintf('in d136.m:  idx = find(Bus(1:135,2) < %.5f);     \n', Qd_min)
% % fprintf('in d136.m:  Bus(idx, [3]) = %.5f;                \n', Qd_min)
fprintf('Bus is not modified                \n')
%             Bus([49 61 93 97 113 115 117 135], [2 3]) = 0.1;

%% 
loop_node_info = {
[136, 17, 18,19,20,22,24,9,8,6,5,4,3,2,1], % loop1
[24,25,26,27,28,31,35,38,135,84,83,15,13,10,8,9], % loop2
[136,1,2,3,4,5,6,7,73,70,68,67,66,65,64,63], % loop3
[66,67,68,70,73,7,6,8,10,13,15,83,81,80,79], % loop4
[136,63,64,65,66,79,78,77,76,75], % loop5
[79,80,81,83,84,135,134,133,132,131], % loop6
[136,75,76,126,125,123,122,121], % loop7
[77,78,79,131,130,129,127,128], % loop8
[76,77,128,127,125,126], % loop9
[136,121,122,123,125,127,129,90,89,88,86,85], % loop10
[90,129,130,131,132,92,91], % loop11
[104,91,92], % loop12
[103,90,91,104], % loop13
[136,85,86,88,89,90,103,101,100,99], % loop14
[104,92,93,94,95,96,50,49,48,47,110,107,106,105], % loop15
% [104,92,93,94,95,96,120,119,118], % loop15-2
[104,105,106,107,110,47,62,120,119,118], % loop16
[48,49,50,96,95,94,93,97,98,55,54,53,52,51], % loop17
[136,99,100,101,103,104,118,119,120,62,47,46,45,43,42,40,39], % loop18
[62,120,96,50,49,48,47], % loop19
[66,67,68,70,73,7,6,8,9,24,25,51,48,47,110,107,106,105,104,92,132,131,79], % loop20
[25,26,27,28,31,35,38,135,98,55,54,53,52,51] % loop21
% [25,26,27,28,31,35,38,135,98,97,93,94,95,96,50,49,48,51] % loop21-2
};
for i = 1:length(loop_node_info)
    loop_node = loop_node_info{i};
    branch_idx = [];
    for j = 1:(length(loop_node)-1)
        idx = find_branch(Branch, loop_node(j), loop_node(j+1));
        if isempty(idx)
        else
            branch_idx(1,j) = idx;
        end
    end
    idx = find_branch(Branch, loop_node(1), loop_node(end)); % last one and first one, form a loop!
    if isempty(idx)
    else
        branch_idx(1, j+1) = idx;
    end    
    branch_idx;
    loop_branch_idx{i} = branch_idx;
end
loop_branch_idx;

%     17    18    19    20    22    24   137     9     8     6     5     4     3     2     1
%     25    26    27    28    31    35    38   139   146    84   138    15    13    10     9   137
%      1     2     3     4     5     6     7   136    73    70    68    67    66    65    64    63
%     67    68    70    73   136     7     8    10    13    15   138    83    81    80   144
%     63    64    65    66   144    79    78    77    76    75  % loop 5

%     80    81    83    84   146   135   134   133   132   145
%     75    76   154   126   125   123   122   121
%     78    79   145   131   130   129   128   155
%     77   155   128   127   126   154
%    121   122   123   125   127   129   148    90    89    88    86    85    % loop 10

%    148   130   131   132   151    92    91
%    147    92   150
%    149    91   147   104
%     85    86    88    89    90   149   103   101   100    99
%    150    93    94    95    96   141    50    49    48   153   110   107    106   105 % loop 15
%    150    93    94    95    96   152   120   119   118  % loop15-2

%    105   106   107   110   153    62   143   120   119   118
%     49    50   141    96    95    94    97    98   142    55    54    53    52    51
%     99   100   101   103   104   118   119   120   143    62    47    46    45    43    42    40    39
%    143   152   141    50    49    48    62
%     67    68    70    73   136     7     8     9   137    25   140    51    48   153   110   107   106   105   150   151   132   145   144

%     26    27    28    31    35    38   139   156   142    55    54    53    52   140   loop21
%     26    27    28    31    35    38   139   156    98    97    94    95    96   141    50    49    51   140   loop21-2

%% 
branch_always_on = [
20 21
22 23
31 32
32 33
33 34

35 36
36 37
28 29
29 30
10 12

13 14
10 11
15 16
73 74
70 71

71 72
68 69
81 82
123 124
86 87

101 102
40 41
43 44
107 108
108 109

109 116
116 117
108 114
114 115
110 111

111 112
112 113
52 56
56 57
57 58

58 59
59 60
60 61
];

for i = 1:length(branch_always_on)
    idx = find_branch(Branch, branch_always_on(i,1), branch_always_on(i,2));
    if isempty(idx)
    else
        branch_idx_always_on(1,i) = idx;
    end
end
branch_idx_always_on;
% branch_idx_always_on = [21 23 32 33 34 36 37 29 30 12 14 11 16 74 71 72 69 82   124 87  102 41 44  108  109  116 117  114   115   111   112   113 56 57 58 59 60 61];

%% zjp 2018-1-13
branches_not_in_loop = branch_always_on;
    idx_not_in_loop = [];
    for i = 1:size(branches_not_in_loop, 1)     
        idx_brch0 = find_branch(Branch, branches_not_in_loop(i,1), ...
            branches_not_in_loop(i,2));
        if idx_brch0
            idx_not_in_loop = [idx_not_in_loop; idx_brch0];  
        else
            fprintf('error at line 618 of d136_v2.m')
            error
        end
    end  
    idx_all = [1:size(Branch,1)];
    brch_idx_in_loop = idx_all;
    brch_idx_in_loop(idx_not_in_loop) = [];